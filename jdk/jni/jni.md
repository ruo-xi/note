# JNI

## 使用方式

### 编写java类

```java

package top.laonaailifa.jdk.java.thread;

/**
 * strat()-> start0()
 * <p>
 * private native void start0();
 */


public class YuThread {

    static {
        System.loadLibrary("YuThreadNative");
    }

    public static void main(String[] args) {
        YuThread yuThread = new YuThread();
        yuThread.callback();
        System.out.println();
        System.out.println("------------------------------------");
        System.out.println();
        yuThread.start0();
    }

    public void run(){
        System.out.println("callback successfully");
    }

    private native void callback();

    private native void start0();
}


//    public static void main(String[] args) {
//        new Thread(() -> {
//            System.out.println("Hellow World");j
//        }).start();
//    }


```

### 生成C语言头文件

```shell
javac -h . YuThread.java
# . : .h文件生成的目录
# YuThread.java 需要编译的源代码文件


ll
#output:
#total 12
#-rw-r--r-- 1 yu yu 529 Oct 17 11:01 top_laonaailifa_jdk_java_thread_YuThread.h
#-rw-r--r-- 1 yu yu 501 Oct 17 11:02 YuThread.class
#-rw-r--r-- 1 yu yu 524 Oct 17 11:01 YuThread.java
```

### 查看生成的.h文件

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class top_laonaailifa_jdk_java_thread_YuThread */

#ifndef _Included_top_laonaailifa_jdk_java_thread_YuThread
#define _Included_top_laonaailifa_jdk_java_thread_YuThread
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     top_laonaailifa_jdk_java_thread_YuThread
 * Method:    callback
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_top_laonaailifa_jdk_java_thread_YuThread_callback
  (JNIEnv *, jobject);

/*
 * Class:     top_laonaailifa_jdk_java_thread_YuThread
 * Method:    start0
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_top_laonaailifa_jdk_java_thread_YuThread_start0
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif

```

### 编写C文件

**需要导入上面的.h文件,并且要调用的函数需要和上面.h中定义的函数名需要一致**

```c
//"downloadfile.c"
#include "pthread.h"
#include "stdio.h"
#include "stdlib.h"
#include "unistd.h"
#include "top_laonaailifa_jdk_java_thread_YuThread.h"

#define NUM_OF_TASKS 5

void *downloadfile(void *filename)
{
    printf("I an downloading file %s\n", (char *)filename);
    sleep(10);
    long downloadtime = rand() % 100;
    printf("I finish downloading the file wtihin %d minutes!\n", downloadtime);
    pthread_exit((void *)downloadtime);
}

void Java_top_laonaailifa_jdk_java_thread_YuThread_start0(JNIEnv * env, jobject c1)
{
    char *files[NUM_OF_TASKS] = {"file1", "file2", "file3", "file4", "file5"};
    pthread_t threads[NUM_OF_TASKS];
    int rc;
    int downloadtime;
    pthread_attr_t thread_attr;
    pthread_attr_init(&thread_attr);
    pthread_attr_setdetachstate(&thread_attr, PTHREAD_CREATE_JOINABLE);

    for (int i = 0; i < NUM_OF_TASKS; i++)
    {
        printf("create thread %d \n", i);
        rc = pthread_create(&threads[i], &thread_attr, downloadfile, (void *)files[i]);
        if (rc)
        {
            printf("create thread error, code : %d \n", rc);
            exit(-1);
        }
    }

    pthread_attr_destroy(&thread_attr);

    for (int i = 0; i < NUM_OF_TASKS; i++)
    {
        pthread_join(threads[i], (void **)&downloadtime);
        printf("Thread %d download the file %s in %d munites.\n", i, files[i], downloadtime);
    }

    pthread_exit(NULL);
}


```

```c
//"callback.c"

#include "stdio.h"
#include "top_laonaailifa_jdk_java_thread_YuThread.h"


JNIEXPORT void JNICALL Java_top_laonaailifa_jdk_java_thread_YuThread_callback(JNIEnv * env, jobject cl){
    jclass cls;
//    jobject obj;
    jmethodID cid;
    jmethodID rid;
    jint ret = 0;
    cls = (*env)->FindClass(env, "top/laonaailifa/jdk/java/thread/YuThread");
    if(cls == NULL){
        printf("FindClass error \n");
        return;
    }
    cid = (*env) ->GetMethodID(env,cls,"<init>","()V");
    if(cid == NULL){
        printf("query constructor error \n");
        return;
    }
//    obj = (*env) ->NewObject(env, cls, cid);
//    if(obj == NULL){
//        printf("NewObject error \n");
//        return;
//    }
    rid = (*env) ->GetMethodID(env,cls,"run","()V");
    ret = (*env) -> CallIntMethod(env,cl,rid,NULL);
    printf("finish call method");
}


```



### 生成动态连接库

**生成的文件就是java文件中load的库**

并且要将该动态连接文件所在的文件夹地址添加到环境变量

jdk默认搜索的lib文件路径:

/usr/java/packages/lib, /usr/lib64, /lib64, /lib, /usr/lib

```shell
ll
#total 16K -h
#-rw-r--r-- 1 yu yu 1.4K Oct 17 11:11 downloadfile.c
#-rw-r--r-- 1 yu yu  529 Oct 17 11:01 top_laonaailifa_jdk_java_thread_YuThread.h
#-rw-r--r-- 1 yu yu  501 Oct 17 11:02 YuThread.class
#-rw-r--r-- 1 yu yu  524 Oct 17 11:01 YuThread.java

#gcc -fPIC -I /usr/lib/jvm/java-11-jdk/include/linux -I /usr/lib/jvm/java-11-jdk/include -shared -o libYuThreadNative.so downloadfile.c

gcc -fPIC -I /usr/lib/jvm/java-11-jdk/include/linux -I /usr/lib/jvm/java-11-jdk/include  -shared -o libYuThreadNative.so callback.c downloadfile.c


#该命令只在当前终端有效
export LD_LIBRARY_PATH=LD_LIBRARY_PATH:/home/yu/source/java-study/src/main/java/top/laonaailifa/jdk/java/thread

```

### 运行

```shell
java  YuThread.java
```

